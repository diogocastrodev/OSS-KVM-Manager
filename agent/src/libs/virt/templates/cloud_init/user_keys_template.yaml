#cloud-config
hostname: {hostname}
manage_etc_hosts: true

users:
  - name: {username}
    sudo: ALL=(ALL) NOPASSWD:ALL
    groups: [sudo, adm]
    shell: /bin/bash
    ssh_authorized_keys:
      - {ssh_public_key}

ssh_pwauth: false
disable_root: true

write_files:
  - path: /etc/ssh/sshd_config.d/99-platform.conf
    permissions: "0644"
    content: |
      PubkeyAuthentication yes
      PasswordAuthentication yes
      KbdInteractiveAuthentication yes
      UsePAM yes

  - path: /etc/netplan/01-netcfg.yaml
    permissions: "0600"
    content: |
      network:
        version: 2
        renderer: networkd
        ethernets:
          eth0:
            dhcp4: true

  - path: /etc/systemd/system/systemd-networkd-wait-online.service.d/override.conf
    permissions: "0644"
    content: |
      [Service]
      TimeoutStartSec=12s
      ExecStart=
      ExecStart=/usr/lib/systemd/systemd-networkd-wait-online --timeout=12 --any

runcmd:
  - netplan generate
  - netplan apply
  - systemctl daemon-reload
  - systemctl restart systemd-networkd
  - systemctl restart systemd-networkd-wait-online || true

# Grow filesystem after qemu-img resize
growpart:
  mode: auto
  devices: ["/"]
resize_rootfs: true

power_state:
  mode: poweroff
  message: "Cloud-init finished; powering off"
  timeout: 30
  condition: true
