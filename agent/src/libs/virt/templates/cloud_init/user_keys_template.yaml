#cloud-config
hostname: {hostname}
manage_etc_hosts: true

users:
  - name: {username}
    sudo: ALL=(ALL) NOPASSWD:ALL
    groups: [sudo, adm]
    shell: /bin/bash
    ssh_authorized_keys:
      - "{ssh_public_key}"

ssh_pwauth: false
disable_root: true

write_files:
  - path: /etc/ssh/sshd_config.d/99-platform.conf
    permissions: "0644"
    content: |
      PubkeyAuthentication yes
      PasswordAuthentication no
      KbdInteractiveAuthentication yes
      UsePAM yes

  - path: /etc/netplan/01-netcfg.yaml
    permissions: "0600"
    content: |
      network:
        version: 2
        renderer: networkd
        ethernets:
          nic0:
            match:
              macaddress: "{mac}"
            set-name: eth0
            dhcp4: false
            addresses:
              - {vm_ip}/{vm_prefix}
            routes:
              - to: default
                via: {vms_gateway}
            nameservers:
              addresses: [1.1.1.1, 8.8.8.8]

runcmd:
  - netplan generate
  - netplan apply
  - systemctl daemon-reload
  - systemctl restart systemd-networkd
  - systemctl restart ssh || systemctl restart sshd || true

# Grow filesystem after qemu-img resize
growpart:
  mode: auto
  devices: ["/"]
resize_rootfs: true

power_state:
  mode: poweroff
  message: "Cloud-init finished; powering off"
  timeout: 30
  condition: true
